{% extends "base.html" %}

{% block title %}Training - Betting Agent{% endblock %}

{% block content %}

<div class="card">
    <h2>‚öôÔ∏è Training Konfiguration</h2>
    <p>W√§hle deinen Training-Modus und konfiguriere die Parameter.</p>
</div>

<!-- Step 1: Mode Selection -->
<div class="card training-steps">
    <h3>
        <span class="step-badge">1</span>
        Training-Modus ausw√§hlen
    </h3>
    
    <div class="mode-selector">
        <label class="mode-option" onclick="selectMode('single')">
            <input type="radio" name="training_mode" value="single" id="mode-single" checked>
            <div class="mode-card">
                <div class="mode-icon">üéØ</div>
                <h4>Single-Agent</h4>
                <p>Ein Agent mit individueller Konfiguration</p>
                <ul class="mode-features">
                    <li>‚úì Schnelles Training (~30-60 Min)</li>
                    <li>‚úì Einfache Konfiguration</li>
                    <li>‚úì Flexible Anpassung</li>
                </ul>
            </div>
        </label>
        
        <label class="mode-option" onclick="selectMode('multi')">
            <input type="radio" name="training_mode" value="multi" id="mode-multi">
            <div class="mode-card">
                <div class="mode-icon">ü§ñ</div>
                <h4>Multi-Agent</h4>
                <p>Mehrere spezialisierte Agenten mit Voting</p>
                <ul class="mode-features">
                    <li>‚úì H√∂here Robustheit</li>
                    <li>‚úì Ensemble-Voting</li>
                    <li>‚úì Diversifizierte Strategien</li>
                    <li>‚ö† L√§ngere Trainingszeit (~2-3h)</li>
                </ul>
            </div>
        </label>
    </div>
</div>

<!-- Step 2: Configuration (Dynamic) -->
<div class="card training-steps" id="config-section">
    <h3>
        <span class="step-badge">2</span>
        <span id="config-title">Parameter konfigurieren</span>
    </h3>
    
    <!-- Single-Agent Config -->
    <div id="single-config" class="config-panel active">
        <form action="{{ url_for('api_start_training') }}" method="POST" id="single-form">
            
            <!-- Profile Selection (Optional) -->
            <div class="form-section">
                <h4>üéØ Profil ausw√§hlen (Optional)</h4>
                <p>Lade ein vordefiniertes Profil oder konfiguriere manuell.</p>
                
                <div class="profile-grid">
                    <div class="profile-card" onclick="loadProfile('conservative')">
                        <span class="profile-emoji">üõ°Ô∏è</span>
                        <h5>Conservative</h5>
                        <p>Wenige, sichere Wetten</p>
                    </div>
                    <div class="profile-card active" onclick="loadProfile('balanced')">
                        <span class="profile-emoji">‚öñÔ∏è</span>
                        <h5>Balanced</h5>
                        <p>Ausgewogene Strategie</p>
                    </div>
                    <div class="profile-card" onclick="loadProfile('aggressive')">
                        <span class="profile-emoji">‚ö°</span>
                        <h5>Aggressive</h5>
                        <p>Viele Value-Wetten</p>
                    </div>
                    <div class="profile-card" onclick="loadProfile('custom')">
                        <span class="profile-emoji">‚öôÔ∏è</span>
                        <h5>Custom</h5>
                        <p>Manuelle Anpassung</p>
                    </div>
                </div>
            </div>
            
            <!-- Season Settings -->
            <div class="form-section">
                <h4>üìÖ Saison-Einstellungen</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="target_season">Ziel-Saison:</label>
                        <input type="number" id="target_season" name="target_season" 
                               value="{{ target_season }}" 
                               min="2016" max="2025" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fine_tune_gamedays">Fine-Tuning Spieltage:</label>
                        <input type="number" id="fine_tune_gamedays" name="fine_tune_gamedays" 
                               value="{{ fine_tune_gamedays }}" 
                               min="1" max="15" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="global_start">Training Start:</label>
                        <input type="number" id="global_start" name="global_start" 
                               value="{{ global_start }}" 
                               min="2016" max="2024" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="global_end">Training Ende:</label>
                        <input type="number" id="global_end" name="global_end" 
                               value="{{ global_end }}" 
                               min="2016" max="2024" required>
                    </div>
                </div>
            </div>
            
            <!-- Betting Settings -->
            <div class="form-section">
                <h4>üí∞ Wett-Einstellungen</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="confidence_threshold">Confidence Threshold:</label>
                        <input type="number" id="confidence_threshold" name="confidence_threshold" 
                               value="{{ confidence_threshold }}" 
                               step="0.05" min="0.5" max="0.95" required>
                        <small>Mindest-Confidence f√ºr Wetten</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="min_edge">Min Edge Required:</label>
                        <input type="number" id="min_edge" name="min_edge" 
                               value="{{ min_edge }}" 
                               step="0.01" min="0" max="0.20" required>
                        <small>Minimum Value-Edge</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bet_amount">Basis-Einsatz (‚Ç¨):</label>
                        <input type="number" id="bet_amount" name="bet_amount" 
                               value="{{ bet_amount }}" 
                               step="1" min="1" max="50" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="max_bet_amount">Max. Einsatz (‚Ç¨):</label>
                        <input type="number" id="max_bet_amount" name="max_bet_amount" 
                               value="{{ max_bet_amount }}" 
                               step="5" min="10" max="100" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="max_bet_rate">Max Bet Rate (%):</label>
                        <input type="number" id="max_bet_rate" name="max_bet_rate" 
                               value="{{ max_bet_rate }}" 
                               step="5" min="10" max="80" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kelly_fraction">Kelly Fraction:</label>
                        <input type="number" id="kelly_fraction" name="kelly_fraction" 
                               value="{{ kelly_fraction }}" 
                               step="0.05" min="0.1" max="0.5" required>
                        <small>Nur relevant wenn Kelly Criterion aktiv</small>
                    </div>
                </div>
                
                <!-- ‚úÖ Kelly Criterion Checkbox -->
                <div class="form-group checkbox">
                    <input type="checkbox" id="use_kelly_criterion" name="use_kelly_criterion" 
                           {% if use_kelly %}checked{% endif %}>
                    <label for="use_kelly_criterion">
                        Kelly Criterion nutzen
                        <small>Berechnet optimale Bet Size basierend auf Edge und Quote</small>
                    </label>
                </div>
            </div>
            
            <!-- Training Parameters -->
            <div class="form-section">
                <h4>üéì Training-Parameter</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="global_timesteps">Global Training Steps:</label>
                        <input type="number" id="global_timesteps" name="global_timesteps" 
                               value="{{ global_timesteps }}" 
                               step="100000" min="100000" required>
                        <small>Haupt-Training (~30-60 Min)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="finetune_timesteps">Fine-Tuning Steps:</label>
                        <input type="number" id="finetune_timesteps" name="finetune_timesteps" 
                               value="{{ finetune_timesteps }}" 
                               step="10000" min="10000" required>
                        <small>Saison-Adaption (~5-10 Min)</small>
                    </div>
                </div>
                
                <div class="form-group checkbox">
                    <input type="checkbox" id="incremental_learning" name="incremental_learning" 
                           {% if incremental_learning %}checked{% endif %}>
                    <label for="incremental_learning">
                        Inkrementelles Lernen
                        <small>Modell lernt nach jedem Spieltag weiter</small>
                    </label>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="button-group">
                <button type="submit" class="btn-primary btn-large" 
                        {% if not data_available %}disabled{% endif %}>
                    üöÄ Single-Agent Training starten
                </button>
            </div>
        </form>
    </div>
    
    <!-- Multi-Agent Config -->
    <div id="multi-config" class="config-panel">
        <form action="{{ url_for('api_start_multi_agent_training') }}" method="POST" id="multi-form">
            
            <!-- Agent Selection -->
            <div class="form-section">
                <h4>ü§ñ Agenten ausw√§hlen</h4>
                
                <div class="agent-selection">
                    <label class="agent-checkbox">
                        <input type="checkbox" name="agents" value="conservative" checked>
                        <div class="agent-info">
                            <span class="agent-emoji">üõ°Ô∏è</span>
                            <div>
                                <strong>Conservative</strong>
                                <p>Conf: 0.70 | Edge: 0.06 | Rate: 20%</p>
                            </div>
                        </div>
                    </label>
                    
                    <label class="agent-checkbox">
                        <input type="checkbox" name="agents" value="balanced" checked>
                        <div class="agent-info">
                            <span class="agent-emoji">‚öñÔ∏è</span>
                            <div>
                                <strong>Balanced</strong>
                                <p>Conf: 0.60 | Edge: 0.04 | Rate: 30%</p>
                            </div>
                        </div>
                    </label>
                    
                    <label class="agent-checkbox">
                        <input type="checkbox" name="agents" value="aggressive" checked>
                        <div class="agent-info">
                            <span class="agent-emoji">‚ö°</span>
                            <div>
                                <strong>Aggressive</strong>
                                <p>Conf: 0.55 | Edge: 0.02 | Rate: 45%</p>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Ensemble Strategy -->
            <div class="form-section">
                <h4>üéØ Ensemble-Strategie</h4>
                
                <div class="form-group">
                    <label for="ensemble_strategy">Entscheidungsmodus:</label>
                    <select id="ensemble_strategy" name="ensemble_strategy" class="form-control">
                        <option value="voting" selected>Majority Voting</option>
                        <option value="weighted">Weighted by Confidence</option>
                        <option value="max_confidence">Max Confidence</option>
                    </select>
                </div>
            </div>
            
            <!-- Season Settings (Same as Single) -->
            <div class="form-section">
                <h4>üìÖ Saison-Einstellungen</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="multi_target_season">Ziel-Saison:</label>
                        <input type="number" id="multi_target_season" name="target_season" 
                               value="{{ target_season }}" 
                               min="2016" max="2025" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="multi_global_timesteps">Training Steps pro Agent:</label>
                        <input type="number" id="multi_global_timesteps" name="global_timesteps" 
                               value="{{ global_timesteps }}" 
                               step="100000" min="100000" required>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="button-group">
                <button type="submit" class="btn-primary btn-large" 
                        {% if not data_available %}disabled{% endif %}>
                    ü§ñ Multi-Agent Training starten
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Data Warning -->
{% if not data_available %}
<div class="alert alert-warning">
    <strong>‚ö†Ô∏è Keine Daten vorhanden!</strong>
    <p>Bitte zuerst Daten herunterladen und verarbeiten.</p>
    <a href="{{ url_for('data_management') }}" class="btn-primary">
        ‚Üí Zur Datenverwaltung
    </a>
</div>
{% endif %}

<style>
/* Training Steps */
.training-steps {
    margin-bottom: 30px;
}

.step-badge {
    display: inline-block;
    width: 35px;
    height: 35px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 35px;
    font-weight: 700;
    margin-right: 15px;
}

/* Mode Selector */
.mode-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.mode-option {
    cursor: pointer;
}

.mode-option input[type="radio"] {
    display: none;
}

.mode-card {
    background: var(--bg-dark);
    border: 3px solid var(--border);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    transition: all 0.3s ease;
    height: 100%;
}

.mode-option input[type="radio"]:checked + .mode-card {
    border-color: var(--primary);
    background: rgba(37, 99, 235, 0.1);
    box-shadow: 0 8px 24px rgba(37, 99, 235, 0.3);
}

.mode-card:hover {
    transform: translateY(-3px);
    border-color: var(--primary-light);
}

.mode-icon {
    font-size: 4em;
    margin-bottom: 15px;
}

.mode-card h4 {
    color: var(--primary-light);
    margin-bottom: 10px;
    font-size: 1.5em;
}

.mode-card p {
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.mode-features {
    text-align: left;
    list-style: none;
    padding: 0;
}

.mode-features li {
    padding: 8px 0;
    color: var(--text-secondary);
    font-size: 0.95em;
}

/* Config Panels */
.config-panel {
    display: none;
}

.config-panel.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Profile Grid */
.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.profile-card {
    background: var(--bg-dark);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.profile-card:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
}

.profile-card.active {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.1);
}

.profile-emoji {
    font-size: 3em;
    display: block;
    margin-bottom: 10px;
}

.profile-card h5 {
    color: var(--primary-light);
    margin-bottom: 5px;
    font-size: 1.1em;
}

.profile-card p {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin: 0;
}

/* Agent Selection */
.agent-selection {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 15px;
}

.agent-checkbox {
    display: flex;
    align-items: center;
    background: var(--bg-dark);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.agent-checkbox:hover {
    border-color: var(--primary);
}

.agent-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    margin-right: 15px;
}

.agent-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.agent-emoji {
    font-size: 2.5em;
}

.agent-info strong {
    display: block;
    color: var(--primary-light);
    font-size: 1.1em;
    margin-bottom: 5px;
}

.agent-info p {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin: 0;
}

/* Form Sections */
.form-section {
    background: rgba(37, 99, 235, 0.05);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    border-left: 4px solid var(--primary);
}

.form-section h4 {
    color: var(--primary-light);
    margin-bottom: 20px;
    font-size: 1.3em;
}

.btn-large {
    padding: 18px 40px;
    font-size: 1.2em;
    width: 100%;
}
</style>

<script>
function selectMode(mode) {
    // Update UI
    document.getElementById('single-config').classList.remove('active');
    document.getElementById('multi-config').classList.remove('active');
    
    if (mode === 'single') {
        document.getElementById('single-config').classList.add('active');
        document.getElementById('config-title').textContent = 'Single-Agent Parameter';
    } else {
        document.getElementById('multi-config').classList.add('active');
        document.getElementById('config-title').textContent = 'Multi-Agent Parameter';
    }
}

function loadProfile(profileName) {
    // Remove active from all profile cards
    document.querySelectorAll('.profile-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active to clicked card
    event.currentTarget.classList.add('active');
    
    // Custom profile = manual configuration
    if (profileName === 'custom') {
        return;
    }
    
    console.log('üîÑ Lade Profil:', profileName);
    
    // Load profile from backend
    fetch(`/load-profile/${profileName}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Profil empfangen:', data);
            
            if (data.success) {
                // ====================================================
                // ENVIRONMENT SETTINGS
                // ====================================================
                if (data.environment) {
                    const env = data.environment;
                    
                    // Confidence Threshold
                    if (env.confidence_threshold !== undefined) {
                        document.getElementById('confidence_threshold').value = env.confidence_threshold;
                        console.log('‚úì confidence_threshold:', env.confidence_threshold);
                    }
                    
                    // Min Edge Required
                    if (env.min_edge_required !== undefined) {
                        document.getElementById('min_edge').value = env.min_edge_required;
                        console.log('‚úì min_edge_required:', env.min_edge_required);
                    }
                    
                    // Max Bet Rate (convert 0.30 to 30)
                    if (env.max_bet_rate !== undefined) {
                        const percentage = Math.round(env.max_bet_rate * 100);
                        document.getElementById('max_bet_rate').value = percentage;
                        console.log('‚úì max_bet_rate:', percentage);
                    }
                    
                    // Bet Amount
                    if (env.bet_amount !== undefined) {
                        document.getElementById('bet_amount').value = env.bet_amount;
                        console.log('‚úì bet_amount:', env.bet_amount);
                    }
                    
                    // Max Bet Amount
                    if (env.max_bet_amount !== undefined) {
                        document.getElementById('max_bet_amount').value = env.max_bet_amount;
                        console.log('‚úì max_bet_amount:', env.max_bet_amount);
                    }
                    
                    // Kelly Fraction
                    if (env.kelly_fraction !== undefined) {
                        document.getElementById('kelly_fraction').value = env.kelly_fraction;
                        console.log('‚úì kelly_fraction:', env.kelly_fraction);
                    }
                    
                    // ‚úÖ Use Kelly Criterion (Checkbox)
                    if (env.use_kelly_criterion !== undefined) {
                        document.getElementById('use_kelly_criterion').checked = env.use_kelly_criterion;
                        console.log('‚úì use_kelly_criterion:', env.use_kelly_criterion);
                        
                        // Update Kelly Fraction field state
                        toggleKellyFractionField(env.use_kelly_criterion);
                    }
                }
                
                // ====================================================
                // TRAINING SETTINGS (Optional)
                // ====================================================
                if (data.profile && data.profile.training) {
                    const train = data.profile.training;
                    
                    // Target Season
                    if (train.target_season !== undefined) {
                        document.getElementById('target_season').value = train.target_season;
                        console.log('‚úì target_season:', train.target_season);
                    }
                    
                    // Fine-Tune Gamedays
                    if (train.fine_tune_gamedays !== undefined) {
                        document.getElementById('fine_tune_gamedays').value = train.fine_tune_gamedays;
                        console.log('‚úì fine_tune_gamedays:', train.fine_tune_gamedays);
                    }
                    
                    // Global Timesteps
                    if (train.global_timesteps !== undefined) {
                        document.getElementById('global_timesteps').value = train.global_timesteps;
                        console.log('‚úì global_timesteps:', train.global_timesteps);
                    }
                    
                    // Finetune Timesteps
                    if (train.finetune_timesteps !== undefined) {
                        document.getElementById('finetune_timesteps').value = train.finetune_timesteps;
                        console.log('‚úì finetune_timesteps:', train.finetune_timesteps);
                    }
                    
                    // Incremental Learning (Checkbox)
                    if (train.incremental_learning !== undefined) {
                        document.getElementById('incremental_learning').checked = train.incremental_learning;
                        console.log('‚úì incremental_learning:', train.incremental_learning);
                    }
                }
                
                // ====================================================
                // SUCCESS FEEDBACK
                // ====================================================
                const profileName = data.profile.name || profileName;
                const emoji = data.profile.emoji || 'üéØ';
                
                alert(`${emoji} Profil "${profileName}" geladen!\n\n‚úì Alle Parameter wurden aktualisiert.`);
                
                console.log('‚úÖ Profil vollst√§ndig geladen');
            } else {
                console.error('‚ùå Keine erfolgreiche Antwort vom Server');
                alert('Fehler: Profil konnte nicht geladen werden');
            }
        })
        .catch(err => {
            console.error('‚ùå Profile loading error:', err);
            alert(`Fehler beim Laden des Profils:\n${err.message}`);
        });
}

// ====================================================
// HELPER FUNCTION: Toggle Kelly Fraction Field
// ====================================================
function toggleKellyFractionField(isKellyActive) {
    const kellyInput = document.getElementById('kelly_fraction');
    const kellyLabel = kellyInput.closest('.form-group').querySelector('label');
    
    if (isKellyActive) {
        kellyInput.disabled = false;
        kellyInput.style.opacity = '1';
        if (kellyLabel) {
            kellyLabel.style.opacity = '1';
        }
    } else {
        kellyInput.disabled = true;
        kellyInput.style.opacity = '0.5';
        if (kellyLabel) {
            kellyLabel.style.opacity = '0.5';
        }
    }
}

// ====================================================
// INITIALIZE: Setup Kelly Criterion Toggle on Page Load
// ====================================================
document.addEventListener('DOMContentLoaded', function() {
    const kellyCheckbox = document.getElementById('use_kelly_criterion');
    
    if (kellyCheckbox) {
        // Add event listener for checkbox changes
        kellyCheckbox.addEventListener('change', function(e) {
            toggleKellyFractionField(e.target.checked);
        });
        
        // Set initial state based on current checkbox value
        toggleKellyFractionField(kellyCheckbox.checked);
    }
});
</script>

{% endblock %}